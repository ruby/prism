import * as nodes from "./nodes.js";

/**
 * A class that knows how to walk down the tree. None of the individual visit
 * methods are implemented on this visitor, so it forces the consumer to
 * implement each one that they need. For a default implementation that
 * continues walking the tree, see the `Visitor` class.
 *
 */
export class BasicVisitor {
  /**
   * Calls `accept` on the given node if it is not `null`, which in turn should
   * call back into this visitor by calling the appropriate `visit*` method.
   *
   * @param {nodes.Node} node
   * @param {any[]} args
   */
  visit(node, ...args) {
    node?.accept(this, ...args);
  }

  /**
   * Visits each node in `nodes` by calling `accept` on each one.
   *
   * @param {nodes.Node[]} node
   * @param {any[]} args
   */
  visitAll(nodes, ...args) {
    nodes.forEach((node) => {
      node?.accept(this, ...args);
    });
  }

  /**
   * Visits the child nodes of `node` by calling `accept` on each one.
   *
   * @param {nodes.Node} node
   * @param {any[]} args
   */
  visitChildNodes(node, ...args) {
    node.compactChildNodes().forEach((childNode) => {
      childNode.accept(this, ...args);
    });
  }
}

/**
 * A visitor is a class that provides a default implementation for every accept
 * method defined on the nodes. This means it can walk a tree without the
 * caller needing to define any special handling. This allows you to handle a
 * subset of the tree, while still walking the whole tree.
 *
 * For example, to find all of the method calls that call the `foo` method, you
 * could write:
 *
 * @example
 * class FooCalls extends Visitor {
 *   visitCallNode(node) {
 *     if (node.name === "foo") {
 *       // Do something with the node
 *     }
 *
 *     // Call super so that the visitor continues walking the tree
 *     super.visitCallNode(node);
 *   }
 * }
 *
 */
export class Visitor extends BasicVisitor {
<%- nodes.each_with_index do |node, index| -%>
<%= "\n" if index != 0 -%>
  /**
   * Visit a <%= node.name %> node.
   *
   * @param {nodes.<%= node.name %>} node
   * @param {any[]} args
   */
  <%= "visit#{node.name.gsub(/_([a-z])/) { $1.upcase }}" %>(node, ...args) {
    this.visitChildNodes(node, ...args);
  }
<%- end -%>
}
